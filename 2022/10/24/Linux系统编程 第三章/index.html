<!DOCTYPE html>
<html lang="zn,en">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Linux系统编程 第三章 - aaaris&#39;s blog</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Linux系统编程 第三章 - aaaris&#39;s blog" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://aaaris.github.io/2022/10/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%20%E7%AC%AC%E4%B8%89%E7%AB%A0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2022-10-24T12:50:01.248Z" />
  
  <meta property="og:article:author" content="aaaris" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="5"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">aaaris&#39;s blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/projects">Projects</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/aaaris" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        

        
        <div class="date" id="date">
            <span>October</span>
            <span>24,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">Linux系统编程 第三章</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>[TOC]</p>
<h1 id="Linux系统编程"><a href="#Linux系统编程" class="headerlink" title="Linux系统编程"></a>Linux系统编程</h1><h2 id="第三章-缓冲输入输出"><a href="#第三章-缓冲输入输出" class="headerlink" title="第三章 缓冲输入输出"></a>第三章 缓冲输入输出</h2><p>所有的磁盘操作都是基于块进行的。</p>
<p>块操作效率随着系统调用次数的增多而急剧下降。</p>
<blockquote>
<p>当请求以块大小整数倍对齐地址时，I&#x2F;O 效率时最理想的。</p>
</blockquote>
<h3 id="3-1-用户——缓冲-I-x2F-O"><a href="#3-1-用户——缓冲-I-x2F-O" class="headerlink" title="3.1 用户——缓冲 I&#x2F;O"></a>3.1 用户——缓冲 I&#x2F;O</h3><p>轻量级 I&#x2F;O 请求通常使用用户缓冲 I&#x2F;O 。</p>
<p>用户缓冲 I&#x2F;O 在用户空间完成，它可以在程序中设定，也可以调用标准库透明地执行。</p>
<p><img src="/2022/10/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%20%E7%AC%AC%E4%B8%89%E7%AB%A0/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20221018231608120.png" alt="image-20221018231608120"></p>
<h4 id="3-1-1-块大小"><a href="#3-1-1-块大小" class="headerlink" title="3.1.1 块大小"></a>3.1.1 块大小</h4><p>实际应用中，块大小一般是512字节，1024字节，2048字节，或4096字节。</p>
<blockquote>
<p>使用用户缓冲 I&#x2F;O，使得程序能操作更小的单位并方便一次写出或读出。</p>
</blockquote>
<h4 id="3-1-2-标准-I-x2F-O"><a href="#3-1-2-标准-I-x2F-O" class="headerlink" title="3.1.2 标准 I&#x2F;O"></a>3.1.2 标准 I&#x2F;O</h4><p>C 标准库中提供了标准 I&#x2F;O 库 stdio.h，其中实现了一个跨平台用户缓冲的解决方案。</p>
<h4 id="3-1-3-文件指针"><a href="#3-1-3-文件指针" class="headerlink" title="3.1.3 文件指针"></a>3.1.3 文件指针</h4><p>FILE 类型，流的概念</p>
<h3 id="3-2-打开文件"><a href="#3-2-打开文件" class="headerlink" title="3.2 打开文件"></a>3.2 打开文件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">FIFE* <span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path, <span class="type">const</span> <span class="type">char</span> * mode)</span>;</span><br></pre></td></tr></table></figure>

<p>成功时，返回一个合法的 FILE 指针。失败时，返回 NULL，设置 errno。</p>
<h4 id="3-2-1-模式"><a href="#3-2-1-模式" class="headerlink" title="3.2.1 模式"></a>3.2.1 模式</h4><p>rwab +</p>
<h4 id="3-2-2-通过文件描述符打开文件"><a href="#3-2-2-通过文件描述符打开文件" class="headerlink" title="3.2.2 通过文件描述符打开文件"></a>3.2.2 通过文件描述符打开文件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">FILE * <span class="title function_">fdopen</span> <span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *mode)</span>;</span><br></pre></td></tr></table></figure>

<p>mode必须和原来打开文件描述符的模式匹配，且关闭流也会关闭相应的文件描述符。</p>
<p>成功时，返回一个合法的 FILE 指针。失败时，返回 NULL，设置 errno。</p>
<h3 id="3-3-关闭流"><a href="#3-3-关闭流" class="headerlink" title="3.3 关闭流"></a>3.3 关闭流</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fclose</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>所有被缓冲但没写出的数据会先被写出。</p>
<p>成功时，返回 0。失败时返回 EOF 并设置 errno。</p>
<h4 id="3-3-1-关闭所有的流"><a href="#3-3-1-关闭所有的流" class="headerlink" title="3.3.1 关闭所有的流"></a>3.3.1 关闭所有的流</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcloseall</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>关闭之前,所有的流会被写出。</p>
<h3 id="3-4-从流中读取数据"><a href="#3-4-从流中读取数据" class="headerlink" title="3.4 从流中读取数据"></a>3.4 从流中读取数据</h3><h4 id="3-4-1-单字节读取"><a href="#3-4-1-单字节读取" class="headerlink" title="3.4.1 单字节读取"></a>3.4.1 单字节读取</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fgetc</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>读取下一个字符并把该无符号字符强转为 int 返回，报错时返回 EOF。</p>
<h4 id="3-4-2-把字符回放到流中"><a href="#3-4-2-把字符回放到流中" class="headerlink" title="3.4.2 把字符回放到流中"></a>3.4.2 把字符回放到流中</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ungetc</span> <span class="params">(<span class="type">int</span> c, FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>每次调用把 c 强转为一个无符号字符并回放流中。成功时，返回 c；失败时返回 EOF。</p>
<h4 id="3-4-3-按行的读取"><a href="#3-4-3-按行的读取" class="headerlink" title="3.4.3 按行的读取"></a>3.4.3 按行的读取</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> * <span class="title function_">fgets</span> <span class="params">(<span class="type">char</span> *str, <span class="type">int</span> size, FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>从流中读取 size - 1 个字节的数据，遇到 EOF 或 ‘\n’ 结束读入，并把数组存入 str 中。</p>
<blockquote>
<p>‘\n’ 会被存入 str 中。</p>
</blockquote>
<h4 id="3-4-4-读取任意字符串"><a href="#3-4-4-读取任意字符串" class="headerlink" title="3.4.4 读取任意字符串"></a>3.4.4 读取任意字符串</h4><p>读取 n-1 个字符到 str中，在任意分隔符 d 处停止读取。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *s;</span><br><span class="line"><span class="type">int</span> c = <span class="number">0</span>;</span><br><span class="line">s = str; </span><br><span class="line"><span class="keyword">while</span> (--n &gt; <span class="number">0</span> &amp;&amp; (c = fgetc (stream)) != EOF &amp;&amp; (*s ++ = c) != d)     </span><br><span class="line">    ;</span><br><span class="line"><span class="keyword">if</span> (c == d)</span><br><span class="line">    *--s = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    *s = <span class="string">&#x27;\0&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-5-读取二进制文件"><a href="#3-4-5-读取二进制文件" class="headerlink" title="3.4.5 读取二进制文件"></a>3.4.5 读取二进制文件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fread</span> <span class="params">(<span class="type">void</span> *buf, <span class="type">size_t</span> size, <span class="type">size_t</span> nr,</span></span><br><span class="line"><span class="params">           	FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>从输入流中读取 nr 个数据，每个数据有 size 个字节，并将数据放到 buf 所指向的缓冲区。</p>
<p>返回读入元素的个数，如果返回数小于 nr 说明读取失败或文件结束。</p>
<h3 id="3-5-从流中写数据"><a href="#3-5-从流中写数据" class="headerlink" title="3.5 从流中写数据"></a>3.5 从流中写数据</h3><h4 id="3-5-1-对齐的讨论"><a href="#3-5-1-对齐的讨论" class="headerlink" title="3.5.1 对齐的讨论"></a>3.5.1 对齐的讨论</h4><h4 id="3-5-2-写入单个字符"><a href="#3-5-2-写入单个字符" class="headerlink" title="3.5.2 写入单个字符"></a>3.5.2 写入单个字符</h4><p>与 fgetc() 相对应 fputc()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fputc</span> <span class="params">(<span class="type">int</span> c, FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-5-3-写入字符串"><a href="#3-5-3-写入字符串" class="headerlink" title="3.5.3 写入字符串"></a>3.5.3 写入字符串</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fputs</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *str, FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>fputs() 的调用将 str 指向的字符串的所有非分隔符部分写入 stream 指向的流中。</p>
<p>成功时，fputs() 返回一个非负整数。失败时，返回 EOF。</p>
<h4 id="3-5-4-写入二进制数据"><a href="#3-5-4-写入二进制数据" class="headerlink" title="3.5.4 写入二进制数据"></a>3.5.4 写入二进制数据</h4><p>与 fread() 对应 fwrite()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite</span> <span class="params">(<span class="type">void</span> *buf,</span></span><br><span class="line"><span class="params">			   <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">               <span class="type">size_t</span> nr,</span></span><br><span class="line"><span class="params">               FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-5-5-缓冲-I-x2F-O-示例程序"><a href="#3-5-5-缓冲-I-x2F-O-示例程序" class="headerlink" title="3.5.5 缓冲 I&#x2F;O 示例程序"></a>3.5.5 缓冲 I&#x2F;O 示例程序</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    FILE *in, *out;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pirate</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="type">char</span> name[<span class="number">100</span>]; <span class="comment">/* real name */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> booty; <span class="comment">/* in pounds sterling */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> beard_len; <span class="comment">/* in inches */</span></span><br><span class="line">	&#125; p, blackbeard = &#123; <span class="string">&quot;Edward Teach&quot;</span>, <span class="number">950</span>, <span class="number">48</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    out =  fopen (<span class="string">&quot;data&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!out) </span><br><span class="line">    &#123;</span><br><span class="line">		perror (<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!fwrite (&amp;blackbeard, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pirate), <span class="number">1</span>, out))</span><br><span class="line">    &#123;</span><br><span class="line">		perror (<span class="string">&quot;fwrite&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fclose (out)) </span><br><span class="line">    &#123;</span><br><span class="line">		perror (<span class="string">&quot;fclose&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    in =  fopen (<span class="string">&quot;data&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!in) </span><br><span class="line">    &#123;</span><br><span class="line">		perror (<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!fread (&amp;p, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pirate), <span class="number">1</span>, in))</span><br><span class="line">    &#123;</span><br><span class="line">		perror (<span class="string">&quot;fwrite&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fclose (in)) </span><br><span class="line">    &#123;</span><br><span class="line">		perror (<span class="string">&quot;fclose&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;name=\&quot;%s\&quot; booty=%lu beard_len=%u\n&quot;</span>,</span><br><span class="line">           p.name, p.booty, p.beard_len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于变量长度、对齐等不同，不同程序——即使是不同机器上的同一程序——不一定能正确地读取 fwrite() 写入的数据。</p>
</blockquote>
<h3 id="3-6-定位流"><a href="#3-6-定位流" class="headerlink" title="3.6 定位流"></a>3.6 定位流</h3><p>fseek() 函数，标准 I&#x2F;O 最常用的定位函数，操纵流指向文件中由 offset 和 whence 指定的位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fseek</span> <span class="params">(FILE *stream, <span class="type">long</span> offset, <span class="type">int</span> whence)</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> whence 等价于 lseek() 中的 origin。</p>
<p>fseek() 不返回更新后的位置，返回 0 或 -1 表示成功与否。</p>
</blockquote>
<p>fsetpos() 函数，将流的位置设置到 pos 处。</p>
<p>它和将 whence 设置为 SEEK_SET 时的 fseek() 功能一致。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsetpos</span> <span class="params">(FILE *stream, <span class="type">fpos_t</span> *pos)</span>;</span><br></pre></td></tr></table></figure>



<p>rewind() 函数将位置重置到流的初始位置，并清空错误标记。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">rewind</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-6-1-获得当前流位置"><a href="#3-6-1-获得当前流位置" class="headerlink" title="3.6.1 获得当前流位置"></a>3.6.1 获得当前流位置</h4><p>ftell() 函数返回当前流的位置。错误时，返回 -1，并设置 errno。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">long</span> <span class="title function_">ftell</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>选择性的，还有 fgetpos() 函数，用 pos 获取当前流的位置，成功时返回 0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fgetpos</span> <span class="params">(FILE *stream, <span class="type">fpos_t</span> *pos)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-7-清洗一个流"><a href="#3-7-清洗一个流" class="headerlink" title="3.7 清洗一个流"></a>3.7 清洗一个流</h3><p>fflush() 函数用来将用户缓冲区写入内核缓冲区，并保证数据都通过 write() 写出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fflush</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>成功时，返回 0 ，失败时，返回 EOF，并设置 errno。</p>
<blockquote>
<p>如果需要的话，在调用 fflush() 之后调用 fsync()：</p>
<p>​	先保证用户缓冲区被写入内核，然后保证内核缓冲区被写入到磁盘中。</p>
</blockquote>
<h3 id="3-8-错误和文件结束"><a href="#3-8-错误和文件结束" class="headerlink" title="3.8 错误和文件结束"></a>3.8 错误和文件结束</h3><p>一些标准的 I&#x2F;O 接口无法区分错误和 EOF 机制，为此提供 ferror() 和 feof()。</p>
<p>ferror() 测试是否在流上设置了错误标志：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ferror</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>feof() 测试文件结尾标志是否被设置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">feof</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>clearerr() 清空流错误标志和文件结尾标志：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">clearerr</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-9-获得关联的文件描述符"><a href="#3-9-获得关联的文件描述符" class="headerlink" title="3.9 获得关联的文件描述符"></a>3.9 获得关联的文件描述符</h3><p>为了获得流的文件描述符，可以使用 fileno()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fileno</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>成功时，返回 fd，失败时，它返回 -1。</p>
<blockquote>
<p>最好在执行获取文件描述符之前对流进行 flush。</p>
<p>最好永远不要混用 I&#x2F;O 操作。</p>
</blockquote>
<h3 id="3-10-控制缓冲"><a href="#3-10-控制缓冲" class="headerlink" title="3.10 控制缓冲"></a>3.10 控制缓冲</h3><ul>
<li>不缓冲<ul>
<li>数据直接提交内核</li>
</ul>
</li>
<li>行缓冲<ul>
<li>以行为单位执行，每当遇到换行符就提交到内核。（标准输出默认为行缓冲）</li>
</ul>
</li>
<li>块缓冲<ul>
<li>适用于文件，默认与文件相关的流都是块缓冲。在标准 I&#x2F;O 中，称为全缓冲。</li>
</ul>
</li>
</ul>
<p>标准 I&#x2F;O 提供一个用来控制使用缓冲类型的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setvbuf</span> <span class="params">(FILE *stream, <span class="type">char</span> *buf, <span class="type">int</span> mode, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="comment">/* _IONBF  无缓冲 */</span></span><br><span class="line"><span class="comment">/* _IOLBF  行缓冲 */</span></span><br><span class="line"><span class="comment">/* _IOFBF  块缓冲 */</span></span><br></pre></td></tr></table></figure>

<p>除了 _IONBF 情况下 buf 和 size 被忽略，buf 可以被用为指定缓冲区。若 buf 为空，缓冲区则由 glibc 自动分配。</p>
<blockquote>
<p>setvbuf() 函数必须在打开流后，执行操作前被调用。</p>
<p>应注意，在流关闭时供其使用的缓冲区必须存在。</p>
</blockquote>
<h3 id="3-11-线程安全"><a href="#3-11-线程安全" class="headerlink" title="3.11 线程安全"></a>3.11 线程安全</h3><p>标准 I&#x2F;O 函数本质上是线程安全的，在单独一个函数调用的上下文中，其操作时原子的。</p>
<h4 id="3-11-1-手动文件加锁"><a href="#3-11-1-手动文件加锁" class="headerlink" title="3.11.1 手动文件加锁"></a>3.11.1 手动文件加锁</h4><p>flockfile() 会等待流被解锁，然后获得锁，增加锁计数，成为流的所有者线程，然后返回：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">flockfile</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>funlockfile() 减少与流相关的锁的计数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">funlockfile</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果锁计数器达到了0，当前线程放弃流的所有权，另一个线程现在能获得锁。</p>
</blockquote>
<p>ftrylockfile() 是 flockfile() 的非阻塞版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ftrylockfile</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<p>如果流加了锁，返回非零值，否则进行相关操作且返回 0。</p>
<h4 id="3-11-2-不加锁流操作"><a href="#3-11-2-不加锁流操作" class="headerlink" title="3.11.2 不加锁流操作"></a>3.11.2 不加锁流操作</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fgetc_unlocked</span> <span class="params">(FILE *stream)</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">fgets_unlocked</span> <span class="params">(<span class="type">char</span> *str, <span class="type">int</span> size, FILE *stream)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fread_unlocked</span> <span class="params">(<span class="type">void</span> *buf, <span class="type">size_t</span> size, <span class="type">size_t</span> nr, FILE *stream)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fputc_unlocked</span> <span class="params">(<span class="type">int</span> c, FILE *stream)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fputs_unlocked</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *str, FILE *stream)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite_unlocked</span> <span class="params">(<span class="type">void</span> *buf, <span class="type">size_t</span> size, <span class="type">size_t</span> nr, FILE *stream)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fflush_unlocked</span> <span class="params">(FILE *stream)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">feof_unlocked</span> <span class="params">(FILE *stream)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">ferror_unlocked</span> <span class="params">(FILE *stream)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fileno_unlocked</span> <span class="params">(FILE *stream)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">clearerr_unlocked</span> <span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-12-对标准-I-x2F-O的批评"><a href="#3-12-对标准-I-x2F-O的批评" class="headerlink" title="3.12 对标准 I&#x2F;O的批评"></a>3.12 对标准 I&#x2F;O的批评</h3><ul>
<li>fgets() 有时不能满足要求</li>
<li>gets() 太不安全</li>
<li>双副本的性能影响。</li>
</ul>
<h3 id="3-13-结论"><a href="#3-13-结论" class="headerlink" title="3.13 结论"></a>3.13 结论</h3>
    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by aaaris, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2022/10/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%20%E7%AC%AC%E5%9B%9B%E7%AB%A0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Linux系统编程 第四章</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2022/10/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%20%E7%AC%AC%E4%BA%8C%E7%AB%A0/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Linux系统编程 第二章</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/projects" class="item">Projects</a>
                
                <a href="/resume" class="item">Resume</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Projects</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/aaaris" class="item">GitHub</a>
                
                <a href="2997600742@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2022 aaaris<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>